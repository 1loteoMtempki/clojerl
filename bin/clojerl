#!/usr/bin/env sh
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  echo "Usage: `basename $0` [options] [.clje file] [data]

  -h, --help            Print this help
  -v                    Prints version and exits

  --compile             Compile files
  -pa PATH              Adds PATH to the beginning of the code path
  -pz PATH              Adds PATH to the end of the code path
  -o PATH               Specify output directory for compiled files
  -t, --time            Print the time spent on compiling
  -vv, --verbose        Verbose compiling

  --clojure.main ARGS   Run clojure.main/main with the provided ARGS,
                        this should be the last option when used." >&2
  exit 0
fi

readlink_f () {
  cd "$(dirname "$1")" > /dev/null
  filename="$(basename "$1")"
  if [ -h "$filename" ]; then
    readlink_f "$(readlink "$filename")"
  else
    echo "`pwd -P`/$filename"
  fi
}

SELF=$(readlink_f "$0")
CLJE_BINDIR=$(dirname "$SELF")
CLJE_ROOT=$(dirname "$CLJE_BINDIR")

ERL_ARGS="$ERL_ARGS -s clojerl_cli start +pc unicode -noshell"

while [ "$#" -gt 1 ]
do
    key="$1"

    case $key in
        -pa)
            ERL_ARGS="$ERL_ARGS -pa $2"
            shift # past argument
            ;;
        -pz)
            ERL_ARGS="$ERL_ARGS -pz $2"
            shift # past argument
            ;;
        *)
            break
            ;;
    esac
    shift # past argument or value
done

export ERL_LIBS="$CLJE_ROOT/_build/default/lib:$ERL_LIBS"
exec erl $ERL_ARGS -extra "$@"
